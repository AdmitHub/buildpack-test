#!/usr/bin/env bash
# https://devcenter.heroku.com/articles/buildpack-api#bin-compile

# TODO: Use node buildpack and just make this super simple
### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)
PROFILE_D_PATH="$BUILD_DIR/.profile.d"
# required by `set_env()`
# see: https://github.com/heroku/buildpack-stdlib/blob/2611c7d236cfc367eecee9488cf0459d0276955c/stdlib.sh#L69
PROFILE_PATH="$PROFILE_D_PATH/statsd.sh"

### Load the standard lib

STDLIB_FILE=$(mktemp -t stdlib.XXXXX)
curl --silent --retry 5 --retry-max-time 15 'https://lang-common.s3.amazonaws.com/buildpack-stdlib/v7/stdlib.sh' > "$STDLIB_FILE"
source "$STDLIB_FILE"

### Load env vars

export_env "$ENV_DIR"

### Install aws cli
puts_step 'install aws cli'
if [ ! -d "$CACHE_DIR/awscli/awscli-bundle" ]; then
    mkdir -p "$CACHE_DIR/awscli"
    curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "$CACHE_DIR/awscli/awscli-bundle.zip"
    unzip "$CACHE_DIR/awscli/awscli-bundle.zip" -d "$CACHE_DIR/awscli"
fi
$CACHE_DIR/awscli/awscli-bundle/install -b ~/bin/aws
export PATH=~/bin:$PATH

### Vendor files into the build dir (which becomes /app at runtime)

cd "$BUILD_DIR"


### Install node/yarn

# create directory for installed utilities
mkdir -p .heroku/node
mkdir -p .heroku/yarn
# add to path
export PATH="$PATH:$BUILD_DIR/.heroku/node/bin:$BUILD_DIR/.heroku/yarn/bin"
export PATH="$PATH:/app/.heroku/node/bin"
# https://github.com/AdmitHub/heroku-buildpack-python/blob/49863be611110fbee9bdbc768ea722f496127ac1/bin/compile#L316
set_env PATH "$PATH"

puts_step 'install node & yarn'

curl --silent --retry 5 --retry-max-time 15 "https://nodejs.org/dist/v11.11.0/node-v11.11.0-linux-x64.tar.xz" -o /tmp/node.tar.xz
tar xf /tmp/node.tar.xz -C .heroku/node --strip 1

curl --silent --retry 5 --retry-max-time 15 -L "https://github.com/yarnpkg/yarn/releases/download/v1.15.0/yarn-v1.15.0.tar.gz" -o /tmp/yarn.tar.gz
tar zxf /tmp/yarn.tar.gz -C .heroku/yarn --strip 1

echo 'yarn version:' $(yarn --version)
echo 'node version:' $(node --version)

### Install node dependencies
cd "$BUILD_DIR/frontend"
puts_step 'install node dependencies'
# move cached node_modules
if [ -d $CACHE_DIR/node-modules-cache/node_modules ]; then
    echo '>> found cached node_modules directory'
    mv  $CACHE_DIR/node-modules-cache/node_modules $BUILD_DIR/frontend/node_modules
fi
# setup yarn cache
mkdir -p $CACHE_DIR/yarn-install-cache
yarn install --frozen-lockfile --non-interactive --cache-folder $CACHE_DIR/yarn-install-cache
# install toml for poetry conversion script
yarn add --cache-folder $CACHE_DIR/yarn-install-cache --no-lockfile toml

### Convert poetry.lock to requirements.txt
puts_step 'convert python dependencies'
cp "$BP_DIR/toml-to-requirements.js" .

if [ -f $BUILD_DIR/backend/poetry.lock ]; then
  LOCKFILE=$BUILD_DIR/backend/poetry.lock
elif [ -f $BUILD_DIR/backend/pyproject.lock ]; then
  LOCKFILE=$BUILD_DIR/backend/pyproject.lock
else
  echo "Lockfile not found!" 1>&2
  exit 1
fi

node 'toml-to-requirements.js' "$LOCKFILE" > "$BUILD_DIR/requirements.txt"
puts_step 'converted python requirements'
cat "$BUILD_DIR/requirements.txt"

### Build webpack bundle
puts_step 'build webpack bundle'
yarn build

# move cache back
if [ -d $BUILD_DIR/frontend/node_modules ]; then
    echo '>> saving node_modules directory'
    mkdir -p $CACHE_DIR/node-modules-cache
    mv $BUILD_DIR/frontend/node_modules  $CACHE_DIR/node-modules-cache
fi

### Configure NGINX
puts_step 'configure nginx'
mkdir -p "$BUILD_DIR/config"
cp "$BUILD_DIR/nginx/nginx.conf.erb" "$BUILD_DIR/config"

### Install StatsD
puts_step 'setup statsd'
STATSD_VERSION="0.8.3"
STATSD_FILE_NAME="v$STATSD_VERSION.zip"
wget "https://github.com/statsd/statsd/archive/$STATSD_FILE_NAME"
unzip "$STATSD_FILE_NAME"
STATSD_DEST_DIR="$BUILD_DIR/backend/statsd"
mv "statsd-$STATSD_VERSION" "$STATSD_DEST_DIR"
# install librato backend
pushd "$STATSD_DEST_DIR"
yarn add statsd-librato-backend@2.0.16
popd
# see heroku docs for more info buildpacks with .profile.d/ scripts
# https://devcenter.heroku.com/articles/buildpack-api#profile-d-scripts
mkdir -p "$PROFILE_D_PATH"
mv "$BUILD_DIR/backend/start-statsd.sh" "$PROFILE_PATH"

### Upload frontend static files to S3
puts_step 'upload static files to s3'
aws s3 cp --recursive $BUILD_DIR/frontend/build/static "s3://$S3_PUBLIC_ASSET_BUCKET_NAME/frontend/static"

### Compile stuff

echo "ðŸŽ‰  Finished!"
